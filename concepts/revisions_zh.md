# 修订和同步

Wunderlist API 的每个实体拥有一个只读的 `revision` 属性。`revision` 属性是一个每当实体或其任意子成员在响应后被更新就会改变的整型。当任务的标题改变的时候，任务的修订（revision）属性也会更新，同时该任务所有的爹娘节点包括列表和根实体的复原属性也会一起改变。

## 更新实体

为了保证 Wunderlist 实体被正确执行并且在客户端间保持同步，在实体通过 API 做任何改变之前都必须伴随有 `revision` 属性。服务器使用此属性来确保客户端拥有最新的实体. 如果一个客户端使用一个过期的 `revision` 属性发起请求，这个请求将会失败，并且指示客户端需要获取实体的正确状态并且重新发起请求。

如果一个更新(update)请求失败了，你必须重新获取实体的正确版本，查找与你本地状态冲突的属性比如说注释里的内容，并且在你重新使用正确的 revision 通过 API 提交更改之前想办法解决本地的冲突。

## 继承之俄罗斯套娃

Wunderlist 数据模型的所有元素存储在一个树中，当数据发生改变时，修订后版本会往上冒泡。

- root

  - list

    - task

      - file
      - task_comment
      - note
      - subtask
      - subtask_positions

    - task_positions

    - membership

  - list_positions

  - user

    - setting
    - reminder
    - avatar

## 同步

若必要的话，你可以通过 Wunderlist API 检查根 `revision` 属性，降序地重复遍历每一个树的叶节点，从而完全同步本地拷贝。

当一个客户端发生一个俄罗斯套娃式的同步时，其遵循如下规则：

除非成功获取了子资源，否则获取的修订值和数据不应被提交到本地模型和持久化层。也就是说，我们在一个父数据的所有子数据都成功获取之前，不应该更新其 child-revision。举个例子，除非所有任务已被成功获取，否则我们不应该应用列表数据和修订的更改。

通过将您的本地数据与在俄罗斯套娃式同步期间检索的数据进行比较并比较丢失的 ID，可以找到已删除的项目。 但是，由于任务可能会移动到另一个列表，您应该将一个任务标记为缺失，并且只有当俄罗斯套娃式同步成功完成，且任何列表中不存在该缺失的任务，才将其删除。 此模式可以扩展到任何 "可移动" 的模型类型。
